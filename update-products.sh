#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ Platforma.sluchay

echo "üõçÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ Platforma.sluchay..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "products.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: products.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è –∫—ç—à-–±–∞—Å—Ç–∏–Ω–≥–∞
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
echo "üìÖ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: $TIMESTAMP"

# –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ index.html
sed -i.bak "s/v=.*&nocache=1/v=PRODUCTS_${TIMESTAMP}&nocache=1/g" index.html
sed -i.bak "s/timestamp=.*&cache=KILLED/timestamp=${TIMESTAMP}&cache=KILLED/g" index.html

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -f index.html.bak

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö
echo "üìù –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ git..."
git add products.json index.html

# –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
COMMIT_MESSAGE="üõçÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ - $(date '+%d.%m.%Y %H:%M:%S')"
echo "üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç: $COMMIT_MESSAGE"
git commit -m "$COMMIT_MESSAGE"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ GitHub
echo "üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ GitHub..."
git push origin main

echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –°–∞–π—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –Ω–∞: https://platformasluchay.ru"
